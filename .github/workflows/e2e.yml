name: run-e2e
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
jobs:
  run-e2e-job:
    name: run-e2e-job
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2          
      - uses: actions/setup-go@v3
        with:
          go-version: '^1.17'
      - name: install-dependencies
        run: |
          # Validate go is present
          go version
          # Install and validate kind
          go install sigs.k8s.io/kind@v0.17.0 
          kind version
          # Install and validate kubectl
          curl -LO https://dl.k8s.io/release/v1.21.0/bin/linux/amd64/kubectl
          chmod +x kubectl
          kubectl version --client=true
          # Install and validate helm (quite brittle, fix ASAP)
          HELM_PKG="helm-v3.10.3-linux-amd64.tar.gz"
          curl -LO https://get.helm.sh/"${HELM_PKG}"
          tar -zxvf "${HELM_PKG}"
          mv ./linux-amd64/helm .
          helm version
      - name: setup-k8s-cluster
        run: |
          kind create cluster \
          --image=kindest/node:v1.21.14@sha256:9d9eb5fb26b4fbc0c6d95fa8c790414f9750dd583f5d7cee45d92e8c26670aa1 \
          --config=./e2e/kind-cluster-config.yaml
          --wait 5m
          kubectl get nodes
      - uses: docker/build-push-action@v3
        with:
          push: false
          # Get commit short sha within Github action workflow
          tags: ydb-operator:${GITHUB_SHA::7} # Just name it somehow, we won't upload it anyway
      - name: deploy-operator
        run: |
          kind load docker-image ydb-operator:${GITHUB_SHA::7}
          helm -n ydb-operator install --create-namespace ydb-operator ./deploy/ydb-operator \
          -f ./e2e/operator-values.yaml \
          --set image.repository=ydb-operator \
          --set image.tag=${GITHUB_SHA::7}
          # wait until operator is available, we can't wait until it's ready because of webhooks :'(
          sleep 20
      - name: run-tests
        run: |
          kubectl apply -f ./e2e/manifests/storage.yaml
          kubectl apply -f ./e2e/manifests/database.yaml
          # Namespace and labels are hardcoded in the next command, that is brittle
          kubectl wait --for=condition=ready pod -n ydb -l ydb-cluster=kind-database
      - name: teardown-k8s-cluster
        run: |
          kind delete cluster
